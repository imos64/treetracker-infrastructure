apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: orderer-enforce-security-context
  annotations:
    description: "Enforce security context with non-root, no privilege escalation, and seccomp profile for orderer"
    policies.kyverno.io/category: Security
    policies.kyverno.io/severity: high
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: require-non-root-user
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          namespaces:
          - orderer
    validate:
      message: "Orderer containers must run as non-root user"
      pattern:
        spec:
          =(template):
            =(spec):
              securityContext:
                runAsNonRoot: true
              =(containers):
              - name: "*"
                securityContext:
                  allowPrivilegeEscalation: false
  - name: require-seccomp-profile
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          namespaces:
          - orderer
    validate:
      message: "Orderer containers must use RuntimeDefault seccomp profile"
      pattern:
        spec:
          =(template):
            =(spec):
              =(containers):
              - name: "*"
                securityContext:
                  seccompProfile:
                    type: RuntimeDefault
  - name: drop-all-capabilities
    match:
      any:
      - resources:
          kinds:
          - Pod
          - Deployment
          - StatefulSet
          namespaces:
          - orderer
    validate:
      message: "Orderer containers must drop all Linux capabilities"
      pattern:
        spec:
          =(template):
            =(spec):
              =(containers):
              - name: "*"
                securityContext:
                  capabilities:
                    drop:
                    - ALL
