apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: orderer-validate-secrets
  annotations:
    description: "Validate that orderer MSP and TLS secrets contain required keys"
    policies.kyverno.io/category: Security
    policies.kyverno.io/severity: high
spec:
  validationFailureAction: enforce
  background: true
  rules:
  - name: validate-orderer-msp-secret
    match:
      any:
      - resources:
          kinds:
          - Secret
          namespaces:
          - orderer
          names:
          - "fabric-orderer-msp"
    validate:
      message: "Orderer MSP secret must contain cacerts, signcerts, keystore, and config.yaml keys"
      pattern:
        data:
          cacerts: "?*"
          signcerts: "?*"
          keystore: "?*"
          config.yaml: "?*"
  - name: validate-orderer-tls-secret
    match:
      any:
      - resources:
          kinds:
          - Secret
          namespaces:
          - orderer
          names:
          - "fabric-orderer-tls"
    validate:
      message: "Orderer TLS secret must contain tls.crt, tls.key, and ca.crt keys"
      pattern:
        data:
          tls.crt: "?*"
          tls.key: "?*"
          ca.crt: "?*"
